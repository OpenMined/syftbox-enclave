<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farming Coop</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div id="success-overlay-bg" style="display:none;"></div>
    <div class="container">
        <aside class="sidebar">
            <h2>Menu</h2>
            <button id="datasets-btn" class="sidebar-btn">Datasets</button>
            <button id="jobs-btn" class="sidebar-btn">Jobs</button>
        </aside>
        <main class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>Farming Coop</h1>
                <a href="https://openmined.org" target="_blank" style="display:inline-block; margin-left:auto;">
                    <img src="https://openmined.org/wp-content/uploads/2024/11/logo-1@2x.png" alt="OpenMined Logo" style="height:48px; width:auto; vertical-align:middle; background: white; border-radius: 8px; padding: 2px;">
                </a>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div></div>
                <button id="create-dataset-btn" class="green floating-btn" style="display:none; margin-bottom: 1em;">+ Create Dataset</button>
            </div>
            <div id="datasets-list" style="display:none;"></div>
            <div id="jobs-list" style="display:none;"></div>
            <div id="modal-overlay" class="modal-overlay" style="display:none;">
                <div class="modal flow-ui">
                    <span class="close" id="close-modal">&times;</span>
                    <form id="create-dataset-form" enctype="multipart/form-data">
                        <h2>Create Dataset</h2>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" name="name" required placeholder="Enter dataset name">
                        </div>
                        <div class="form-group">
                            <label>Summary</label>
                            <input type="text" name="summary" required placeholder="Short summary">
                        </div>
                        <div class="form-group">
                            <label>Private Path</label>
                            <input type="file" name="private_path" required>
                        </div>
                        <div class="form-group">
                            <label>Mock Path</label>
                            <input type="file" name="mock_path" required>
                        </div>
                        <div class="form-group">
                            <label>Description Path</label>
                            <input type="file" name="description_path" required>
                        </div>
                        <div class="form-group">
                            <label>Auto Approval</label>
                            <input type="text" name="auto_approval" required placeholder="yes/no">
                        </div>
                        <button type="submit" class="green">Submit</button>
                    </form>
                </div>
            </div>
        </main>
    </div>
    <div id="success-message" class="fade-message success-message overlay-success-wide" style="display:none;">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2705.png" alt="Success" style="width:2.5em;vertical-align:middle;"> <span id="success-text"></span>
    </div>
    <div id="error-message" class="fade-message error-message" style="display:none;">
        <span id="error-text"></span>
        <button type="button" id="close-error" style="margin-left:1em;">Close</button>
    </div>
    <script>
        const datasetsBtn = document.getElementById('datasets-btn');
        const jobsBtn = document.getElementById('jobs-btn');
        const createBtn = document.getElementById('create-dataset-btn');
        const datasetsList = document.getElementById('datasets-list');
        const jobsList = document.getElementById('jobs-list');
        const modalOverlay = document.getElementById('modal-overlay');
        const closeModal = document.getElementById('close-modal');
        const createForm = document.getElementById('create-dataset-form');
        const successTick = document.getElementById('success-tick');

        jobsBtn.onclick = async function() {
            datasetsList.style.display = 'none';
            jobsList.style.display = 'block';
            createBtn.style.display = 'none';
            const resp = await fetch('/jobs');
            const data = await resp.json();
            if (!data.jobs || data.jobs.length === 0) {
                jobsList.innerHTML = '<h2>Jobs</h2><p>No jobs found.</p>';
                return;
            }
            // Dynamically get columns from first job, or use a default set
            const columns = Object.keys(data.jobs[0] || {});
            let html = '<h2>Jobs</h2><div class="table-container"><table class="dataset-table"><thead><tr>';
            for (const col of columns) {
                html += `<th>${col}</th>`;
            }
            html += '</tr></thead><tbody>';
            for (const job of data.jobs) {
                html += '<tr>';
                for (const col of columns) {
                    html += `<td>${job[col] !== undefined ? job[col] : ''}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            jobsList.innerHTML = html;
        };

        datasetsBtn.onclick = async function() {
            jobsList.style.display = 'none';
            datasetsList.style.display = 'block';
            createBtn.style.display = 'inline-block';
            const resp = await fetch('/datasets');
            const data = await resp.json();
            if (data.datasets.length === 0) {
                datasetsList.innerHTML = '<h2>Datasets</h2><p>No datasets found.</p>';
                return;
            }
            // Only show specific columns
            const columns = ["uid", "name", "private", "mock", "summary", "auto_approval"];
            let html = '<h2>Datasets</h2><div class="table-container"><table class="dataset-table"><thead><tr>';
            for (const col of columns) {
                let thClass = (col === 'private' || col === 'mock') ? `${col}-col` : '';
                html += `<th class="${thClass}">${col}</th>`;
            }
            html += '</tr></thead><tbody>';
            for (const ds of data.datasets) {
                html += '<tr>';
                for (const col of columns) {
                    let tdClass = (col === 'private' || col === 'mock') ? `${col}-col` : '';
                    html += `<td class="${tdClass}">${ds[col] !== undefined ? ds[col] : ''}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            datasetsList.innerHTML = html;
        };

        createBtn.onclick = function() {
            // Hide any previous messages
            if (typeof successMsg !== 'undefined') successMsg.style.display = 'none';
            if (typeof errorMsg !== 'undefined') errorMsg.style.display = 'none';
            // Reset the form
            createForm.reset();
            // Clear file input values by replacing them with clones
            const fileInputs = createForm.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                const clone = input.cloneNode(true);
                input.parentNode.replaceChild(clone, input);
            });
            modalOverlay.style.display = 'flex';
        };
        closeModal.onclick = function() {
            modalOverlay.style.display = 'none';
        };
        window.onclick = function(event) {
            if (event.target === modalOverlay) {
                modalOverlay.style.display = 'none';
            }
        };
        createForm.onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(createForm);
            const resp = await fetch('/create-dataset', {
                method: 'POST',
                body: formData
            });
            const result = await resp.json();
            const successMsg = document.getElementById('success-message');
            const errorMsg = document.getElementById('error-message');
            const successText = document.getElementById('success-text');
            const errorText = document.getElementById('error-text');
            const overlayBg = document.getElementById('success-overlay-bg');
            if (resp.ok && result.message) {
                errorMsg.style.display = 'none';
                successText.textContent = result.message;
                modalOverlay.style.display = 'none'; // Close the dialog immediately
                overlayBg.style.display = 'block';
                successMsg.style.display = 'flex';
                successMsg.style.opacity = 1;
                // Bring overlay and message to front
                overlayBg.style.zIndex = 1999;
                successMsg.style.zIndex = 2000;
                setTimeout(() => {
                    successMsg.style.transition = 'opacity 0.7s';
                    successMsg.style.opacity = 0;
                }, 3200);
                setTimeout(() => {
                    successMsg.style.display = 'none';
                    overlayBg.style.display = 'none';
                    datasetsBtn.click();
                    successMsg.style.opacity = 1;
                }, 3800);
            } else {
                successMsg.style.display = 'none';
                errorText.textContent = result.error || 'Unknown error';
                errorMsg.style.display = 'block';
            }
        };
        document.getElementById('close-error').onclick = function() {
            document.getElementById('error-message').style.display = 'none';
        };
        // Hide create button by default
        createBtn.style.display = 'none';
        // Hide jobs list by default
        jobsList.style.display = 'none';
        // Update the file input elements for private_path and mock_path to allow folder selection
        // This must be done after the DOM loads
        window.addEventListener('DOMContentLoaded', () => {
            const privateInput = document.querySelector('input[name="private_path"]');
            const mockInput = document.querySelector('input[name="mock_path"]');
            if (privateInput) {
                privateInput.setAttribute('webkitdirectory', '');
                privateInput.setAttribute('directory', '');
                privateInput.removeAttribute('multiple'); // Let browser handle multiple files if folder
            }
            if (mockInput) {
                mockInput.setAttribute('webkitdirectory', '');
                mockInput.setAttribute('directory', '');
                mockInput.removeAttribute('multiple');
            }
        });
    </script>
    <style>
        .fade-message {
            margin-top: 1em;
            padding: 1em 1.5em;
            border-radius: 8px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.7s;
        }
        .success-message {
            background: #eafbe7;
            color: #219150;
            border: 1.5px solid #27ae60;
        }
        .error-message {
            background: #fdeaea;
            color: #c0392b;
            border: 1.5px solid #e74c3c;
        }
        #success-overlay-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(255,255,255,0.4);
            z-index: 1999;
            display: block;
            pointer-events: auto;
        }
        .overlay-success {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            min-width: 320px;
            min-height: 80px;
            box-shadow: 0 4px 32px rgba(39,174,96,0.18);
            font-size: 1.3em;
            background: rgba(255,255,255,0.97);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        .overlay-success-wide {
            position: fixed;
            top: 15vh;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2000;
            min-width: 420px;
            min-height: 80px;
            max-width: 80vw;
            width: 60vw;
            box-shadow: 0 4px 32px rgba(39,174,96,0.18);
            font-size: 1.3em;
            background: rgba(255,255,255,0.97);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            border: 2px solid #27ae60;
            pointer-events: auto;
        }
        @media (max-width: 600px) {
            .overlay-success-wide {
                min-width: 90vw;
                width: 95vw;
                font-size: 1em;
            }
        }
        #modal-overlay {
            position: fixed;
            /* ...existing code... */
            overflow: visible;
        }
        #modal-overlay .modal {
            position: relative;
        }
    </style>
</body>
</html>
