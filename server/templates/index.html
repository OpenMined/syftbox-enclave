<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farming Coop</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2>Menu</h2>
            <button id="datasets-btn" class="sidebar-btn">Datasets</button>
        </aside>
        <main class="main-content">
            <h1>Farming Coop</h1>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div></div>
                <button id="create-dataset-btn" class="green floating-btn" style="display:none; margin-bottom: 1em;">+ Create Dataset</button>
            </div>
            <div id="datasets-list" style="display:none;"></div>
            <div id="modal-overlay" class="modal-overlay" style="display:none;">
                <div class="modal flow-ui">
                    <span class="close" id="close-modal">&times;</span>
                    <form id="create-dataset-form" enctype="multipart/form-data">
                        <h2>Create Dataset</h2>
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" name="name" required placeholder="Enter dataset name">
                        </div>
                        <div class="form-group">
                            <label>Summary</label>
                            <input type="text" name="summary" required placeholder="Short summary">
                        </div>
                        <div class="form-group">
                            <label>Private Path</label>
                            <input type="file" name="private_path" required>
                        </div>
                        <div class="form-group">
                            <label>Mock Path</label>
                            <input type="file" name="mock_path" required>
                        </div>
                        <div class="form-group">
                            <label>Description Path</label>
                            <input type="file" name="description_path" required>
                        </div>
                        <div class="form-group">
                            <label>Auto Approval</label>
                            <input type="text" name="auto_approval" required placeholder="yes/no">
                        </div>
                        <button type="submit" class="green">Submit</button>
                        <div id="success-message" class="fade-message success-message" style="display:none;">
                            <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/2705.png" alt="Success" style="width:2em;vertical-align:middle;"> <span id="success-text"></span>
                        </div>
                        <div id="error-message" class="fade-message error-message" style="display:none;">
                            <span id="error-text"></span>
                            <button type="button" id="close-error" style="margin-left:1em;">Close</button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>
    <script>
        const datasetsBtn = document.getElementById('datasets-btn');
        const createBtn = document.getElementById('create-dataset-btn');
        const datasetsList = document.getElementById('datasets-list');
        const modalOverlay = document.getElementById('modal-overlay');
        const closeModal = document.getElementById('close-modal');
        const createForm = document.getElementById('create-dataset-form');
        const successTick = document.getElementById('success-tick');

        datasetsBtn.onclick = async function() {
            datasetsList.style.display = 'block';
            createBtn.style.display = 'inline-block';
            const resp = await fetch('/datasets');
            const data = await resp.json();
            if (data.datasets.length === 0) {
                datasetsList.innerHTML = '<h2>Datasets</h2><p>No datasets found.</p>';
                return;
            }
            // Only show specific columns
            const columns = ["uid", "name", "private", "mock", "summary", "auto_approval"];
            let html = '<h2>Datasets</h2><div class="table-container"><table class="dataset-table"><thead><tr>';
            for (const col of columns) {
                let thClass = (col === 'private' || col === 'mock') ? `${col}-col` : '';
                html += `<th class="${thClass}">${col}</th>`;
            }
            html += '</tr></thead><tbody>';
            for (const ds of data.datasets) {
                html += '<tr>';
                for (const col of columns) {
                    let tdClass = (col === 'private' || col === 'mock') ? `${col}-col` : '';
                    html += `<td class="${tdClass}">${ds[col] !== undefined ? ds[col] : ''}</td>`;
                }
                html += '</tr>';
            }
            html += '</tbody></table></div>';
            datasetsList.innerHTML = html;
        };

        createBtn.onclick = function() {
            modalOverlay.style.display = 'flex';
            successTick.style.display = 'none';
            createForm.reset();
        };
        closeModal.onclick = function() {
            modalOverlay.style.display = 'none';
        };
        window.onclick = function(event) {
            if (event.target === modalOverlay) {
                modalOverlay.style.display = 'none';
            }
        };
        createForm.onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(createForm);
            const resp = await fetch('/create-dataset', {
                method: 'POST',
                body: formData
            });
            const result = await resp.json();
            const successMsg = document.getElementById('success-message');
            const errorMsg = document.getElementById('error-message');
            const successText = document.getElementById('success-text');
            const errorText = document.getElementById('error-text');
            if (resp.ok && result.message) {
                errorMsg.style.display = 'none';
                successText.textContent = result.message;
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.opacity = 1;
                    successMsg.style.transition = 'opacity 0.7s';
                    successMsg.style.opacity = 0;
                }, 3200); // 2 seconds longer than before (1200 + 2000)
                setTimeout(() => {
                    successMsg.style.display = 'none';
                    modalOverlay.style.display = 'none';
                    datasetsBtn.click();
                    successMsg.style.opacity = 1;
                }, 3800); // 2 seconds longer than before (1800 + 2000)
            } else {
                successMsg.style.display = 'none';
                errorText.textContent = result.error || 'Unknown error';
                errorMsg.style.display = 'block';
            }
        };
        document.getElementById('close-error').onclick = function() {
            document.getElementById('error-message').style.display = 'none';
        };
        // Hide create button by default
        createBtn.style.display = 'none';
        // Update the file input elements for private_path and mock_path to allow folder selection
        // This must be done after the DOM loads
        window.addEventListener('DOMContentLoaded', () => {
            const privateInput = document.querySelector('input[name="private_path"]');
            const mockInput = document.querySelector('input[name="mock_path"]');
            if (privateInput) {
                privateInput.setAttribute('webkitdirectory', '');
                privateInput.setAttribute('directory', '');
                privateInput.removeAttribute('multiple'); // Let browser handle multiple files if folder
            }
            if (mockInput) {
                mockInput.setAttribute('webkitdirectory', '');
                mockInput.setAttribute('directory', '');
                mockInput.removeAttribute('multiple');
            }
        });
    </script>
    <style>
        .fade-message {
            margin-top: 1em;
            padding: 1em 1.5em;
            border-radius: 8px;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.7s;
        }
        .success-message {
            background: #eafbe7;
            color: #219150;
            border: 1.5px solid #27ae60;
        }
        .error-message {
            background: #fdeaea;
            color: #c0392b;
            border: 1.5px solid #e74c3c;
        }
    </style>
</body>
</html>
